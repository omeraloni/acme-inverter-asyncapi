asyncapi: '2.0.0'
info:
  title: ACME Inverter Company ASync API
  version: '1.0.0'
  description: |
    The ASync API provides you metrics from your ACME PV inverter.
  license:
    name: Apache 2.0
    url: 'https://www.apache.org/licenses/LICENSE-2.0'

servers:
  mosquitto:
    url: mqtt://test.mosquitto.org
    protocol: mqtt
    protocolVersion: '3.1.1'

channels:
  acme/{id}/metrics:
    parameters:
      id:
        description: Id of the inverter
        schema:
          type: string
    publish:
      summary: Inform about new metrics.
      operationId: onMetricsReceived
      message:
        payload:
          $ref: '#/components/schemas/Metrics'
      bindings:
        mqtt:
          qos: 1
          retain: true
          bindingVersion: 0.1.0

  acme/{id}/event:
    parameters:
      id:
        description: Id of the inverter
        schema:
          type: string
    publish:
      summary: Inform about incoming events.
      operationId: onEventReceived
      message:
        payload:
          $ref: '#/components/schemas/Event'
      bindings:
        mqtt:
          qos: 0
          retain: false
          bindingVersion: 0.1.0

components:
  schemas:
    Timestamp:
      type: string
      format: date-time
      description: Date and time when the message was sent
    Phases:
      type: array
      itmes:
        type: float
      minItems: 1
      maxItems: 3
      description: Array representaion of a 3 phase measurement, correlating to phase1, phase2 & phase3
    Metrics:
      type: object
      properties:
        timestamp:
          $ref: '#/components/schemas/Timestamp'
        ac_power:
          $ref: '#/components/schemas/Phases'
          description: AC power production
        ac_freq:
          $ref: '#/components/schemas/Phases'
          description: Grid AC frequency
        ac_voltage:
          $ref: '#/components/schemas/Phases'
          description: Grid AC voltage
    Event:
      type: object
      properties:
        timestamp:
          $ref: '#/components/schemas/Timestamp'
        code:
          type: integer
          description: Event code
        name:
          type: string
          description: Event name
        level:
          type: string
          description: Event level
          enum:
            - info
            - warning
            - error
            - debug
      additionalProperties: false